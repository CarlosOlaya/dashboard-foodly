<div class="cobro-overlay">
    <div class="cobro-panel">

        <div class="cobro-header">
            <h2><mat-icon>payments</mat-icon> Cobrar Mesa {{ mesaNumero }}</h2>
            <button class="cobro-close" (click)="cerrado.emit()"><mat-icon>close</mat-icon></button>
        </div>

        <div class="cobro-body">

            <!-- Resumen de items -->
            <div class="cobro-section">
                <h3>Resumen</h3>
                <div class="cobro-items-list">
                    <div *ngFor="let item of itemsFactura" class="cobro-item-row">
                        <span class="cobro-item-name">{{ item.plato_nombre }}</span>
                        <span class="cobro-item-qty">x{{ item.cantidad }}</span>
                        <span class="cobro-item-price" *ngIf="!item.descuento_monto || item.descuento_monto === 0">
                            {{ item.precio * item.cantidad | moneda }}
                        </span>
                        <span class="cobro-item-price" *ngIf="(item.descuento_monto || 0) > 0"
                            style="display:flex; flex-direction:column; align-items:flex-end;">
                            <span style="text-decoration:line-through; font-size:11px; color:#aaa;">{{ item.precio *
                                item.cantidad | moneda }}</span>
                            <span style="color:#16a34a; font-weight:700;">{{ (item.precio * item.cantidad) -
                                (item.descuento_monto
                                || 0) | moneda }}</span>
                        </span>
                        <span *ngIf="(item.descuento_monto || 0) > 0" class="cobro-item-desc-tag">
                            -{{ item.descuento_porcentaje || 0 }}%
                        </span>
                    </div>
                </div>
                <div *ngIf="totalDescuentosItems > 0 || facturaDescuento > 0" class="cobro-descuentos-summary">
                    <div *ngIf="totalDescuentosItems > 0" class="breakdown-row text-red">
                        <span>Desc. items</span>
                        <span>-{{ totalDescuentosItems | moneda }}</span>
                    </div>
                    <div *ngIf="facturaDescuento > 0" class="breakdown-row text-red">
                        <span>Desc. mesa</span>
                        <span>-{{ facturaDescuento | moneda }}</span>
                    </div>
                </div>
                <div class="cobro-subtotal-line">
                    <span>Subtotal</span>
                    <span>{{ subtotal | moneda }}</span>
                </div>
            </div>


            <!-- Servicio -->
            <div class="cobro-section">
                <h3>Servicio</h3>
                <div class="servicio-options">
                    <!-- Modo porcentaje -->
                    <div class="servicio-mode-tabs">
                        <button class="mode-tab" [class.active]="servicioModo === 'porcentaje'"
                            (click)="setServicioModo('porcentaje')">
                            Porcentaje
                        </button>
                        <button class="mode-tab" [class.active]="servicioModo === 'valor'"
                            (click)="setServicioModo('valor')">
                            Valor fijo
                        </button>
                    </div>

                    <div *ngIf="servicioModo === 'porcentaje'" class="cobro-desc-chips" style="margin-top: 8px;">
                        <button class="desc-chip" [class.active]="servicioPct === 5"
                            (click)="setServicioPct(5)">5%</button>
                        <button class="desc-chip" [class.active]="servicioPct === 10"
                            (click)="setServicioPct(10)">10%</button>
                        <button class="desc-chip" [class.active]="servicioPct === 15"
                            (click)="setServicioPct(15)">15%</button>
                        <button class="desc-chip" [class.active]="servicioPct === 20"
                            (click)="setServicioPct(20)">20%</button>
                        <div class="desc-custom">
                            <input type="number" min="0" max="100" [(ngModel)]="servicioPct" style="width: 45px;">
                            <span>%</span>
                        </div>
                    </div>

                    <div *ngIf="servicioModo === 'valor'" style="margin-top: 8px;">
                        <div class="desc-custom">
                            <span>$</span>
                            <input type="number" min="0" [(ngModel)]="servicioValor" placeholder="Valor"
                                style="width: 90px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Método de pago -->
            <div class="cobro-section">
                <h3>Método de Pago</h3>

                <div *ngIf="!pagoDividido" class="cobro-metodos">
                    <button class="metodo-btn" [class.active]="metodoPago === 'efectivo'"
                        (click)="metodoPago = 'efectivo'">
                        <mat-icon>payments</mat-icon> Efectivo
                    </button>
                    <button class="metodo-btn" [class.active]="metodoPago === 'tarjeta'"
                        (click)="metodoPago = 'tarjeta'">
                        <mat-icon>credit_card</mat-icon> Tarjeta
                    </button>
                    <button class="metodo-btn" [class.active]="metodoPago === 'transferencia'"
                        (click)="metodoPago = 'transferencia'">
                        <mat-icon>account_balance</mat-icon> Transfer.
                    </button>
                </div>

                <button class="cobro-dividir-toggle" (click)="togglePagoDividido()">
                    <mat-icon>{{ pagoDividido ? 'toggle_on' : 'toggle_off' }}</mat-icon>
                    Pago dividido (múltiples métodos)
                </button>

                <!-- Pago dividido -->
                <div *ngIf="pagoDividido" class="cobro-pagos-divide">
                    <!-- Header de columnas -->
                    <div class="pago-row pago-row-header" *ngIf="servicioMonto > 0">
                        <span class="pago-col-label" style="flex:1">Método</span>
                        <span class="pago-col-label" style="width:90px; text-align:right">Subtotal</span>
                        <span class="pago-col-label" style="width:80px; text-align:right">Servicio</span>
                        <span style="width:28px"></span>
                    </div>
                    <div *ngFor="let pago of pagos; let i = index" class="pago-row">
                        <select [(ngModel)]="pago.metodo" class="pago-select">
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                        <input type="number" [(ngModel)]="pago.monto" class="pago-monto" placeholder="Subtotal">
                        <div class="pago-propina-wrap" *ngIf="servicioMonto > 0">
                            <input type="number" [(ngModel)]="pago.propina" class="pago-propina-input"
                                placeholder="Servicio">
                            <button class="pago-propina-fill" (click)="asignarPropinaRestante(i)"
                                title="Asignar servicio restante aquí">
                                <mat-icon>vertical_align_bottom</mat-icon>
                            </button>
                        </div>
                        <button *ngIf="pagos.length > 2" class="pago-remove" (click)="quitarPago(i)">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                    <button class="pago-add" (click)="agregarPago()">
                        <mat-icon>add</mat-icon> Agregar método
                    </button>
                    <!-- Balance de montos -->
                    <div class="pago-balance" [class.pago-ok]="Math.abs(diferenciaPagos) <= 1"
                        [class.pago-error]="Math.abs(diferenciaPagos) > 1">
                        <span>Subtotal: {{ sumaPagos | moneda }} / {{ subtotal | moneda }}</span>
                        <span *ngIf="diferenciaPagos > 1">Faltan: {{ diferenciaPagos | moneda }}</span>
                        <span *ngIf="diferenciaPagos < -1">Sobran: {{ (-diferenciaPagos) | moneda }}</span>
                        <span *ngIf="Math.abs(diferenciaPagos) <= 1">✓ Cuadrado</span>
                    </div>
                    <!-- Balance de propinas -->
                    <div class="pago-balance" *ngIf="servicioMonto > 0"
                        [class.pago-ok]="Math.abs(diferenciaPropinas) <= 1"
                        [class.pago-error]="Math.abs(diferenciaPropinas) > 1">
                        <span>Servicio: {{ sumaPropinas | moneda }} / {{ servicioMonto | moneda }}</span>
                        <span *ngIf="diferenciaPropinas > 1">Faltan: {{ diferenciaPropinas | moneda }}</span>
                        <span *ngIf="diferenciaPropinas < -1">Sobran: {{ (-diferenciaPropinas) | moneda }}</span>
                        <span *ngIf="Math.abs(diferenciaPropinas) <= 1">✓ Cuadrado</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer con total -->
        <div class="cobro-footer">
            <div class="cobro-total-breakdown" *ngIf="servicioMonto > 0">
                <div class="breakdown-row">
                    <span>Subtotal</span>
                    <span>{{ subtotal | moneda }}</span>
                </div>
                <div class="breakdown-row">
                    <span>Servicio</span>
                    <span>+{{ servicioMonto | moneda }}</span>
                </div>
            </div>
            <div class="cobro-total-display">
                <span>TOTAL A COBRAR</span>
                <span class="cobro-total-amount">{{ total | moneda }}</span>
            </div>
            <div class="cobro-footer-actions">
                <button class="cobro-confirm-btn" [disabled]="procesando" (click)="confirmarCobro()">
                    <mat-icon>{{ procesando ? 'sync' : 'check_circle' }}</mat-icon>
                    {{ procesando ? 'Procesando...' : 'Confirmar Cobro' }}
                </button>
            </div>
        </div>

    </div>
</div>